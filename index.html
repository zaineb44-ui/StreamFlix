<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamFlix - TMDB Streaming</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* [Previous CSS content remains exactly the same] */
    </style>
</head>
<body>
    <!-- [Previous HTML content remains the same until the script section] -->

    <script>
        // TMDB API Configuration
        const API_KEY = 'f5c8d5add995935daa212039d7b34e5d';
        const API_URL = 'https://api.themoviedb.org/3';
        const IMAGE_URL = 'https://image.tmdb.org/t/p/w500';
        const VIDFAST_URL = 'https://vidfast.co';

        // DOM Elements
        const moviesGrid = document.getElementById('movies-grid');
        const tvGrid = document.getElementById('tv-grid');
        const historyGrid = document.getElementById('history-grid');
        const watchlistGrid = document.getElementById('watchlist-grid');
        const searchMoviesGrid = document.getElementById('search-movies');
        const searchTvGrid = document.getElementById('search-tv');
        const playerContainer = document.getElementById('player-container');
        const playerIframe = document.getElementById('player-iframe');
        const backButton = document.getElementById('back-button');
        const searchInput = document.querySelector('.search-input');
        const searchButton = document.querySelector('.search-button');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const seasonSelector = document.getElementById('season-selector');
        const seasonButtons = document.getElementById('season-buttons');
        const episodeSelector = document.getElementById('episode-selector');
        const episodeButtons = document.getElementById('episode-buttons');
        const clearHistoryBtn = document.getElementById('clear-history');
        const searchResultsTab = document.getElementById('search-results');

        // Auth elements
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userGreeting = document.getElementById('user-greeting');
        const authModal = document.getElementById('auth-modal');
        const closeModal = document.querySelector('.close-modal');
        const authForm = document.getElementById('auth-form');
        const authModalTitle = document.getElementById('auth-modal-title');
        const emailField = document.getElementById('email-field');
        const usernameField = document.getElementById('username-field');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authError = document.getElementById('auth-error');

        // Current state
        let currentMediaType = 'movie';
        let currentTvShowId = null;
        let currentSeason = 1;
        let currentEpisodes = [];
        let mediaCache = {};
        let watchlist = JSON.parse(localStorage.getItem('watchlist')) || [];
        let currentActiveTab = 'movies';
        let isLoginMode = true;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            fetchPopularMovies();
            fetchPopularTVShows();
            setupEventListeners();
            displayWatchlist();
            checkSession();
            
            if (document.querySelector('.tab-button[data-tab="history"]').classList.contains('active')) {
                displayWatchHistory();
            }
        });

        // Set up event listeners
        function setupEventListeners() {
            // [Previous event listener code remains the same]
        }

        // Perform search
        async function performSearch() {
            const query = searchInput.value.trim();
            if (query === '') return;

            // Hide all tabs and show search results
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            searchResultsTab.style.display = 'block';
            searchResultsTab.classList.add('active');
            currentActiveTab = 'search-results';
            
            searchMoviesGrid.innerHTML = `<div class="loading"><i class="fas fa-spinner"></i> Searching movies...</div>`;
            searchTvGrid.innerHTML = `<div class="loading"><i class="fas fa-spinner"></i> Searching TV shows...</div>`;
            
            try {
                // Search for movies and TV shows simultaneously
                const [moviesResponse, tvResponse] = await Promise.all([
                    fetch(`${API_URL}/search/movie?api_key=${API_KEY}&query=${encodeURIComponent(query)}`),
                    fetch(`${API_URL}/search/tv?api_key=${API_KEY}&query=${encodeURIComponent(query)}`)
                ]);

                if (!moviesResponse.ok || !tvResponse.ok) {
                    throw new Error('Failed to fetch search results');
                }

                const [moviesData, tvData] = await Promise.all([
                    moviesResponse.json(),
                    tvResponse.json()
                ]);

                searchMoviesGrid.innerHTML = '';
                searchTvGrid.innerHTML = '';
                
                if (moviesData.results.length === 0) {
                    searchMoviesGrid.innerHTML = '<div class="no-results">No movies found</div>';
                } else {
                    moviesData.results.forEach(movie => createMediaCard(movie, searchMoviesGrid, 'movie', true));
                }
                
                if (tvData.results.length === 0) {
                    searchTvGrid.innerHTML = '<div class="no-results">No TV shows found</div>';
                } else {
                    tvData.results.forEach(show => createMediaCard(show, searchTvGrid, 'tv', true));
                }
            } catch (error) {
                console.error('Error searching:', error);
                searchMoviesGrid.innerHTML = '<div class="error">Error loading movies</div>';
                searchTvGrid.innerHTML = '<div class="error">Error loading TV shows</div>';
            }
        }

        // Fetch popular movies
        async function fetchPopularMovies() {
            moviesGrid.innerHTML = `<div class="loading"><i class="fas fa-spinner"></i> Loading movies...</div>`;
            
            try {
                const response = await fetch(`${API_URL}/movie/popular?api_key=${API_KEY}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                moviesGrid.innerHTML = '';
                
                if (data.results.length === 0) {
                    moviesGrid.innerHTML = '<div class="no-results">No movies found</div>';
                    return;
                }
                
                data.results.forEach(movie => createMediaCard(movie, moviesGrid, 'movie'));
            } catch (error) {
                console.error('Error fetching movies:', error);
                moviesGrid.innerHTML = '<div class="error">Error loading movies. Please try again later.</div>';
            }
        }

        // Fetch popular TV shows
        async function fetchPopularTVShows() {
            tvGrid.innerHTML = `<div class="loading"><i class="fas fa-spinner"></i> Loading TV shows...</div>`;
            
            try {
                const response = await fetch(`${API_URL}/tv/popular?api_key=${API_KEY}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                tvGrid.innerHTML = '';
                
                if (data.results.length === 0) {
                    tvGrid.innerHTML = '<div class="no-results">No TV shows found</div>';
                    return;
                }
                
                data.results.forEach(show => createMediaCard(show, tvGrid, 'tv'));
            } catch (error) {
                console.error('Error fetching TV shows:', error);
                tvGrid.innerHTML = '<div class="error">Error loading TV shows. Please try again later.</div>';
            }
        }

        // [Rest of the JavaScript functions remain the same]
    </script>
</body>
</html>
